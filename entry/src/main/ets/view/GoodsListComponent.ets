/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as commonConst from '../common/CommonConstants';
import { GoodsListItemType } from '../viewmodel/InitialData';
import { ListDataSource } from '../viewmodel/ListDataSource';
import SortDialog, { SortType } from './SortDialogComponent';
import { saveSortType, getSortType } from '../viewmodel/PreferencesUtils';
import { sortGoodsList } from '../viewmodel/SortUtils';

/**
 * å•†å“åˆ—è¡¨ç»„ä»¶
 * ä½¿ç”¨LazyForEachå®žçŽ°å•†å“åˆ—è¡¨çš„æ‡’åŠ è½½æ¸²æŸ“
 * æ”¯æŒè§¦åº•åŠ è½½æ›´å¤šåŠŸèƒ½
 * æ”¯æŒæœç´¢ç»“æžœæ˜¾ç¤º
 */
@Component
export default struct GoodsList {
  // æä¾›åˆ—è¡¨æ•°æ®æº
  @Provide goodsListData: ListDataSource = new ListDataSource();
  // è®°å½•è§¦æ‘¸èµ·å§‹ç‚¹Yåæ ‡
  private startTouchOffsetY: number = 0;
  // è®°å½•è§¦æ‘¸ç»“æŸç‚¹Yåæ ‡
  private endTouchOffsetY: number = 0;
  // æ˜¯å¦æ­£åœ¨åŠ è½½
  @State isLoading: boolean = false;
  // æ˜¯å¦æ­£åœ¨åˆ·æ–°
  @State isRefreshing: boolean = false;
  // åˆ†ç±»
  @Prop category: string = 'selected';
  // æœç´¢ç»“æžœå•†å“åˆ—è¡¨
  @Prop searchResults: GoodsListItemType[] = [];
  // æ˜¯å¦ä¸ºæœç´¢æ¨¡å¼
  @Prop isSearchMode: boolean = false;
  // æ˜¯å¦æ˜¾ç¤ºæŽ’åºå¼¹çª—
  @State showSortDialog: boolean = false;
  // å½“å‰æŽ’åºç±»åž‹
  @State currentSortType: SortType = SortType.RECOMMEND;
  // æŽ’åºåŽçš„æœç´¢ç»“æžœï¼ˆç”¨äºŽæœç´¢æ¨¡å¼ï¼‰
  @State sortedSearchResults: GoodsListItemType[] = [];
  // æ˜¯å¦ä½¿ç”¨æ‡’åŠ è½½ï¼ˆæŽ’åºæ—¶ç¦ç”¨ï¼‰
  @State useLazyLoad: boolean = true;

  aboutToAppear() {
    // å½“åˆ†ç±»æ”¹å˜æ—¶ï¼Œæ›´æ–°æ•°æ®æº
    this.goodsListData.setCategory(this.category);
    
    // åŠ è½½ä¿å­˜çš„æŽ’åºç±»åž‹
    const savedSortType = getSortType();
    this.currentSortType = savedSortType;
    this.goodsListData.setSortType(savedSortType);
    
    // æ›´æ–°æ‡’åŠ è½½çŠ¶æ€
    this.useLazyLoad = this.goodsListData.isLazyLoadMode();
  }

  /**
   * ç›‘å¬æœç´¢ç»“æžœæ˜¾ç¤ºå˜åŒ–ï¼Œåº”ç”¨æŽ’åº
   */
  aboutToUpdate() {
    // å½“åˆ†ç±»æ”¹å˜æ—¶ï¼Œæ›´æ–°æ•°æ®æºå’Œæ‡’åŠ è½½çŠ¶æ€
    this.goodsListData.setCategory(this.category);
    this.useLazyLoad = this.goodsListData.isLazyLoadMode();
    
    // å½“æœç´¢ç»“æžœå˜åŒ–æ—¶ï¼Œåº”ç”¨å½“å‰æŽ’åº
    if (this.isSearchMode) {
      if (this.searchResults.length > 0) {
        this.sortedSearchResults = sortGoodsList(this.searchResults, this.currentSortType);
      } else {
        // æ¸…ç©ºæŽ’åºåŽçš„æœç´¢ç»“æžœ
        this.sortedSearchResults = [];
      }
    }
  }

  // å¤„ç†ä¸‹æ‹‰åˆ·æ–°
  private handleRefresh() {
    if (this.isRefreshing) {
      return;
    }

    this.isRefreshing = true;

    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(() => {
      this.goodsListData.refreshData();
      this.isRefreshing = false;
    }, commonConst.REFRESH_DELAY);
  }

  // æž„å»ºå•ä¸ªå•†å“é¡¹
  @Builder
  buildGoodsItem(item: GoodsListItemType) {
    Row() {
      // å•†å“å›¾ç‰‡åŒºåŸŸ
      Column() {
        Image(item?.goodsImg)
          .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
          .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
          .objectFit(ImageFit.Contain)
          .draggable(false) // ç¦æ­¢å›¾ç‰‡æ‹–æ‹½
          .borderRadius(8)
      }
      .width(commonConst.GOODS_IMAGE_WIDTH)
      .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // å•†å“ä¿¡æ¯åŒºåŸŸ
      Column() {
        // å•†å“åç§°
        Text(item?.goodsName)
          .fontSize(commonConst.NORMAL_FONT_SIZE)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })

        // å¹¿å‘Šè¯­
        Text(item?.advertisingLanguage)
          .fontColor($r('app.color.gray'))
          .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8, right: commonConst.MARGIN_RIGHT })

        // è¯„ä»·å’Œä»·æ ¼ä¿¡æ¯è¡Œ
        Row() {
          // è¯„ä»·ä¿¡æ¯
          Text(item?.evaluate)
            .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
            .fontColor($r('app.color.deepGray'))
            .width(commonConst.EVALUATE_WIDTH)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // ä»·æ ¼ä¿¡æ¯ï¼ˆçº¢è‰²çªå‡ºæ˜¾ç¤ºï¼‰
          Text(item?.price)
            .fontSize(commonConst.NORMAL_FONT_SIZE)
            .fontColor($r('app.color.freshRed'))
            .fontWeight(FontWeight.Bold)
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .width(commonConst.GOODS_LIST_WIDTH)
      }
      .padding(commonConst.GOODS_LIST_PADDING) // è®¾ç½®å†…è¾¹è·
      .width(commonConst.GOODS_FONT_WIDTH)
      .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .justifyContent(FlexAlign.SpaceBetween) // å­å…ƒç´ ä¸¤ç«¯å¯¹é½
    }
    .justifyContent(FlexAlign.SpaceBetween) // å•†å“å›¾ç‰‡å’Œä¿¡æ¯åŒºåŸŸä¸¤ç«¯å¯¹é½
    .height(commonConst.GOODS_LIST_HEIGHT)
    .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
  }

  /**
   * å¤„ç†æŽ’åºé€‰æ‹©
   */
  private handleSortSelect(sortType: SortType) {
    console.log('========================================');
    console.log('=== GoodsListComponent.handleSortSelect ===');
    console.log(`é€‰æ‹©çš„æŽ’åºç±»åž‹: ${sortType}`);
    console.log(`å½“å‰æŽ’åºç±»åž‹: ${this.currentSortType}`);
    console.log(`æ˜¯å¦ä¸ºæœç´¢æ¨¡å¼: ${this.isSearchMode}`);
    console.log(`å½“å‰åˆ†ç±»: ${this.category}`);
    
    this.currentSortType = sortType;
    
    // ä¿å­˜æŽ’åºç±»åž‹
    saveSortType(sortType);
    console.log('æŽ’åºç±»åž‹å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
    
    if (this.isSearchMode) {
      // æœç´¢æ¨¡å¼ä¸‹ï¼Œå¯¹æœç´¢ç»“æžœè¿›è¡ŒæŽ’åº
      console.log('æœç´¢æ¨¡å¼ï¼šå¯¹æœç´¢ç»“æžœè¿›è¡ŒæŽ’åº');
      console.log(`æœç´¢ç»“æžœæ•°é‡: ${this.searchResults.length}`);
      
      if (this.searchResults.length > 0) {
        console.log('å¼€å§‹æŽ’åºæœç´¢ç»“æžœ...');
        this.sortedSearchResults = sortGoodsList(this.searchResults, sortType);
        console.log(`æŽ’åºåŽç»“æžœæ•°é‡: ${this.sortedSearchResults.length}`);
      } else {
        console.log('æœç´¢ç»“æžœä¸ºç©ºï¼Œæ— éœ€æŽ’åº');
        this.sortedSearchResults = [];
      }
    } else {
      // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå¯¹æ•°æ®æºè¿›è¡ŒæŽ’åº
      console.log('æ­£å¸¸æ¨¡å¼ï¼šå¯¹æ•°æ®æºè¿›è¡ŒæŽ’åº');
      const dataCount = this.goodsListData.getAllData().length;
      console.log(`æ•°æ®æºå•†å“æ•°é‡: ${dataCount}`);
      
      this.goodsListData.setSortType(sortType);
      
      // æ›´æ–°æ‡’åŠ è½½çŠ¶æ€
      this.useLazyLoad = this.goodsListData.isLazyLoadMode();
      console.log(`æ‡’åŠ è½½çŠ¶æ€: ${this.useLazyLoad ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
      
      // éªŒè¯æŽ’åºåŽçš„æ•°æ®
      const sortedData = this.goodsListData.getAllData();
      console.log(`æŽ’åºåŽæ•°æ®æºå•†å“æ•°é‡: ${sortedData.length}`);
      
      if (dataCount !== sortedData.length) {
        console.error(`[æŽ’åºé”™è¯¯] æ•°æ®æºæ•°é‡å˜åŒ–: ${dataCount} -> ${sortedData.length}`);
      }
    }
    
    console.log('=== handleSortSelect å®Œæˆ ===');
    console.log('========================================\n');
  }

  /**
   * æ˜¾ç¤ºæŽ’åºå¼¹çª—
   */
  private openSortDialog() {
    this.showSortDialog = true;
  }

  /**
   * éšè—æŽ’åºå¼¹çª—
   */
  private closeSortDialog() {
    this.showSortDialog = false;
  }

  /**
   * èŽ·å–æŽ’åºæŒ‰é’®æ–‡æœ¬
   */
  private getSortButtonText(): string {
    switch (this.currentSortType) {
      case SortType.RECOMMEND:
        return 'æŽ¨èæŽ’åº';
      case SortType.PRICE_LOW_TO_HIGH:
        return 'ä»·æ ¼â†‘';
      case SortType.PRICE_HIGH_TO_LOW:
        return 'ä»·æ ¼â†“';
      default:
        return 'æŽ’åº';
    }
  }

  // å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼ˆä»…åœ¨éžæœç´¢æ¨¡å¼ä¸‹ï¼‰
  private handleTouch(event?: TouchEvent) {
    // æœç´¢æ¨¡å¼ä¸‹ä¸å¤„ç†è§¦æ‘¸äº‹ä»¶
    if (this.isSearchMode) {
      return;
    }
    
    // æŽ’åºæ¨¡å¼ä¸‹ç¦ç”¨æ‡’åŠ è½½ï¼Œä¸å¤„ç†è§¦åº•åŠ è½½æ›´å¤š
    if (!this.useLazyLoad) {
      return;
    }

    if (event === undefined) {
      return;
    }
    switch (event.type) {
      case TouchType.Down: // è§¦æ‘¸æŒ‰ä¸‹
        this.startTouchOffsetY = event.touches[0].y;
        break;
      case TouchType.Move: // è§¦æ‘¸ç§»åŠ¨
        this.endTouchOffsetY = event.touches[0].y;
        // åˆ¤æ–­æ˜¯å¦å‘ä¸Šæ»‘åŠ¨ä¸”æŽ¥è¿‘åº•éƒ¨ï¼Œå¦‚æžœæ˜¯åˆ™åŠ è½½æ›´å¤šæ•°æ®ï¼ˆä»…åœ¨æ‡’åŠ è½½æ¨¡å¼ä¸‹ï¼‰
        if (this.startTouchOffsetY - this.endTouchOffsetY > 100 && !this.isLoading && this.useLazyLoad) {
          this.isLoading = true;
          this.goodsListData.pushData();
          setTimeout(() => {
            this.isLoading = false;
          }, 500);
        }
        // åˆ¤æ–­æ˜¯å¦ä¸‹æ‹‰åˆ·æ–°
        if (this.endTouchOffsetY - this.startTouchOffsetY > 100 && !this.isRefreshing) {
          this.handleRefresh();
        }
        break;
    }
  }

  build() {
    Column() {
      // æŽ’åºæŒ‰é’®ï¼ˆåœ¨æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½æ˜¾ç¤ºï¼‰
      Row() {
        Button(this.getSortButtonText())
          .type(ButtonType.Normal)
          .fontSize(commonConst.NORMAL_FONT_SIZE)
          .backgroundColor('#F5F5F5')
          .fontColor(Color.Black)
          .borderRadius(20)
          .height(36)
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            this.openSortDialog();
          })
      }
      .width('100%')
      .height(50)
      .justifyContent(FlexAlign.End)
      .padding({ right: 16, top: 8, bottom: 8 })
      .transition(TransitionEffect.OPACITY.animation({ duration: 200 }))

      // å•†å“åˆ—è¡¨å†…å®¹
      Row() {
        // å¦‚æžœæ˜¯æœç´¢æ¨¡å¼ä¸”æœ‰æœç´¢ç»“æžœ
        if (this.isSearchMode && this.searchResults.length > 0) {
          // æ˜¾ç¤ºæœç´¢ç»“æžœï¼ˆä½¿ç”¨æŽ’åºåŽçš„ç»“æžœï¼‰
          List({ space: commonConst.LIST_ITEM_SPACE }) {
            ForEach(
              this.sortedSearchResults.length > 0 ? this.sortedSearchResults : this.searchResults,
              (item: GoodsListItemType) => {
                ListItem() {
                  this.buildGoodsItem(item)
                }
              },
              (item: GoodsListItemType) => item.id.toString()
            )
          }
          .width('100%')
          .height('100%')
          .edgeEffect(EdgeEffect.Spring) // ä½¿ç”¨å¼¹ç°§æ•ˆæžœ
        } else if (this.isSearchMode && this.searchResults.length === 0) {
          // æœç´¢æ¨¡å¼ä½†æ²¡æœ‰æœç´¢ç»“æžœ
          Column() {
            Text('ðŸ”')
              .fontSize(60)
              .margin({ bottom: 20 })
            Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“')
              .fontSize(commonConst.NORMAL_FONT_SIZE)
              .fontColor($r('app.color.gray'))
              .margin({ bottom: 10 })
            Text('è¯·å°è¯•å…¶ä»–å…³é”®è¯')
              .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
              .fontColor($r('app.color.deepGray'))
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        } else {
          // æ­£å¸¸å•†å“åˆ—è¡¨æ¨¡å¼
          List({ space: commonConst.LIST_ITEM_SPACE }) {
            // æ ¹æ®æ˜¯å¦å¯ç”¨æ‡’åŠ è½½é€‰æ‹©ä¸åŒçš„æ¸²æŸ“æ–¹å¼
            if (this.useLazyLoad) {
              // ä½¿ç”¨æ‡’åŠ è½½æ–¹å¼æ¸²æŸ“åˆ—è¡¨é¡¹ï¼ˆæŽ¨èæŽ’åºæ¨¡å¼ï¼‰
              LazyForEach(this.goodsListData, (item: GoodsListItemType) => {
                ListItem() {
                  this.buildGoodsItem(item)
                }
                // ç›‘å¬è§¦æ‘¸äº‹ä»¶ï¼Œå®žçŽ°è§¦åº•åŠ è½½æ›´å¤š
                .onTouch((event?: TouchEvent) => {
                  this.handleTouch(event);
                })
              }, (item: GoodsListItemType) => item.id.toString())
            } else {
              // ä½¿ç”¨æ™®é€šForEachæ¸²æŸ“ï¼ˆæŽ’åºæ¨¡å¼ï¼Œå·²åŠ è½½æ‰€æœ‰æ•°æ®ï¼‰
              ForEach(this.goodsListData.getAllData(), (item: GoodsListItemType) => {
                ListItem() {
                  this.buildGoodsItem(item)
                }
              }, (item: GoodsListItemType) => item.id.toString())
            }
          }
          .width('100%')
          .height('100%')
          .edgeEffect(EdgeEffect.Spring) // ä½¿ç”¨å¼¹ç°§æ•ˆæžœ
        }

        // çŠ¶æ€æç¤ºä¿¡æ¯
        Column() {
          // åˆ·æ–°æç¤º
          if (this.isRefreshing) {
            Text('æ­£åœ¨åˆ·æ–°...')
              .fontSize(commonConst.NORMAL_FONT_SIZE)
              .fontColor($r('app.color.deepGray'))
              .textAlign(TextAlign.Center)
              .width('100%')
              .margin({ top: 20, bottom: 20 })
          }
          // åŠ è½½æ›´å¤šæç¤ºï¼ˆä»…åœ¨éžæœç´¢æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
          else if (!this.isSearchMode) {
            if (this.isLoading) {
              Text('æ­£åœ¨åŠ è½½æ›´å¤š...')
                .fontSize(commonConst.NORMAL_FONT_SIZE)
                .fontColor($r('app.color.deepGray'))
                .textAlign(TextAlign.Center)
                .width('100%')
                .margin({ top: 20, bottom: 40 })
            } else {
              Text($r('app.string.to_bottom'))
                .fontSize(commonConst.NORMAL_FONT_SIZE)
                .fontColor($r('app.color.deepGray'))
                .textAlign(TextAlign.Center)
                .width('100%')
                .margin({ top: 20, bottom: 40 })
            }
          }
        }
        .justifyContent(FlexAlign.Center)
        .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
        .height('100%')
        .backgroundColor($r('app.color.primaryBgColor'))
      }
      .justifyContent(FlexAlign.Center)
      .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .height('100%')

      // æŽ’åºå¼¹çª—
      if (this.showSortDialog) {
        SortDialog({
          isVisible: this.showSortDialog,
          currentSort: this.currentSortType,
          onSortSelected: (sortType: SortType) => {
            this.handleSortSelect(sortType);
            this.closeSortDialog();
          },
          onClose: () => {
            this.closeSortDialog();
          }
        })
      }
    }
    .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
    .height('100%')
    .backgroundColor($r('app.color.primaryBgColor'))
  }
}