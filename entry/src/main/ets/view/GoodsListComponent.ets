/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as commonConst from '../common/CommonConstants';
import { GoodsListItemType } from '../viewmodel/InitialData';
import { ListDataSource } from '../viewmodel/ListDataSource';
import SortDialog, { SortType, PriceRangeFilter } from './SortDialogComponent';
import { saveSortType, getSortType } from '../viewmodel/PreferencesUtils';
import { searchGoodsByKeyword } from '../viewmodel/SearchUtils';
import { sortGoodsList } from '../viewmodel/SortUtils';

/**
 * å•†å“åˆ—è¡¨ç»„ä»¶
 * ä½¿ç”¨LazyForEachå®ç°å•†å“åˆ—è¡¨çš„æ‡’åŠ è½½æ¸²æŸ“
 * æ”¯æŒè§¦åº•åŠ è½½æ›´å¤šåŠŸèƒ½
 */
@Component
export default struct GoodsList {
  // æä¾›åˆ—è¡¨æ•°æ®æº
  @Provide goodsListData: ListDataSource = new ListDataSource();
  // è®°å½•è§¦æ‘¸èµ·å§‹ç‚¹Yåæ ‡
  private startTouchOffsetY: number = 0;
  // è®°å½•è§¦æ‘¸ç»“æŸç‚¹Yåæ ‡
  private endTouchOffsetY: number = 0;
  // æ˜¯å¦æ­£åœ¨åŠ è½½
  private isLoading: boolean = false;
  // æ˜¯å¦å·²ç»åˆ°è¾¾åº•éƒ¨ï¼ˆæ²¡æœ‰æ›´å¤šæ•°æ®ï¼‰
  @State hasReachedBottom: boolean = false;
  // æ˜¯å¦æ­£åœ¨åˆ·æ–°
  @State isRefreshing: boolean = false;
  // åˆ†ç±»
  @Prop category: string = 'selected';

  // æ–°å¢ï¼šæœç´¢ç›¸å…³çŠ¶æ€
  @State searchKeyword: string = '';
  @State isSearchMode: boolean = false;
  @State showSortDialog: boolean = false;
  @State currentSortType: SortType = SortType.RECOMMEND;
  @State currentPriceFilter: PriceRangeFilter | null = null;
  // æœç´¢ç»“æœç›¸å…³çŠ¶æ€
  @State searchResults: GoodsListItemType[] = [];
  @State sortedSearchResults: GoodsListItemType[] = [];
  @State useLazyLoad: boolean = true;

  aboutToAppear() {
    // å½“åˆ†ç±»æ”¹å˜æ—¶ï¼Œæ›´æ–°æ•°æ®æº
    this.goodsListData.setCategory(this.category);

    // åˆå§‹åŒ–æ’åºç±»å‹
    this.currentSortType = getSortType();
    this.goodsListData.setSortType(this.currentSortType);

    // å»¶è¿Ÿåˆå§‹åŒ–åº•éƒ¨çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®æºå®Œå…¨åˆå§‹åŒ–
    setTimeout(() => {
      this.updateBottomStatus();
      console.log('ç»„ä»¶åˆå§‹åŒ–å®Œæˆï¼Œæ˜¯å¦åˆ°è¾¾åº•éƒ¨:', this.hasReachedBottom);
    }, 100);
  }

  // æ–°å¢ï¼šç»Ÿä¸€æ›´æ–°åº•éƒ¨çŠ¶æ€çš„æ–¹æ³•
  private updateBottomStatus() {
    if (this.isSearchMode) {
      // æœç´¢æ¨¡å¼ä¸‹ï¼Œåº•éƒ¨çŠ¶æ€ç”±æœç´¢ç»“æœæ•°é‡å†³å®š
      this.hasReachedBottom = this.sortedSearchResults.length > 0;
    } else {
      // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
      const canLoadMore = this.goodsListData.canLoadMore();
      this.hasReachedBottom = !canLoadMore;
      console.log(`åº•éƒ¨çŠ¶æ€æ›´æ–°: canLoadMore=${canLoadMore}, hasReachedBottom=${this.hasReachedBottom}`);
    }
  }

  // ç›‘å¬æ•°æ®æºå˜åŒ–ï¼Œæ›´æ–°åº•éƒ¨çŠ¶æ€
  aboutToUpdate() {
    this.updateBottomStatus();
  }

  // å¤„ç†ä¸‹æ‹‰åˆ·æ–°
  private handleRefresh() {
    if (this.isRefreshing) {
      return;
    }

    this.isRefreshing = true;

    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(() => {
      this.goodsListData.refreshData();
      this.isRefreshing = false;
    }, commonConst.REFRESH_DELAY);
  }

  // æ–°å¢ï¼šå¤„ç†æœç´¢
  private handleSearch(keyword: string) {
    console.log('=== GoodsListComponent.handleSearch ===');
    console.log('æœç´¢å…³é”®è¯:', keyword);
    console.log('å½“å‰åˆ†ç±»:', this.category);
    
    this.searchKeyword = keyword;
    this.isSearchMode = keyword.trim().length > 0;
    
    if (this.isSearchMode) {
      // æœç´¢æ¨¡å¼ä¸‹ï¼Œç¦ç”¨æ‡’åŠ è½½
      this.useLazyLoad = false;
      
      // æ‰§è¡Œæœç´¢
      this.searchResults = searchGoodsByKeyword(this.category, keyword.trim());
      console.log('æœç´¢ç»“æœæ•°é‡:', this.searchResults.length);
      
      // åº”ç”¨å½“å‰æ’åº
      if (this.searchResults.length > 0) {
        this.sortedSearchResults = sortGoodsList(this.searchResults, this.currentSortType, this.currentPriceFilter || undefined);
        console.log('æ’åºåæœç´¢ç»“æœæ•°é‡:', this.sortedSearchResults.length);
      } else {
        this.sortedSearchResults = [];
      }
    } else {
      // éæœç´¢æ¨¡å¼ï¼Œæ¢å¤æ‡’åŠ è½½
      this.useLazyLoad = true;
      // æ¸…ç©ºæœç´¢ç»“æœ
      this.searchResults = [];
      this.sortedSearchResults = [];
    }
    
    // æ›´æ–°åº•éƒ¨çŠ¶æ€
    this.updateBottomStatus();
    
    console.log('æœç´¢æ¨¡å¼:', this.isSearchMode);
    console.log('æ‡’åŠ è½½çŠ¶æ€:', this.useLazyLoad);
    console.log('=== handleSearch å®Œæˆ ===\n');
  }

  /**
   * æ„å»ºå•ä¸ªå•†å“é¡¹
   */
  @Builder
  buildGoodsItem(item: GoodsListItemType) {
    Row() {
      // å•†å“å›¾ç‰‡åŒºåŸŸ
      Column() {
        Image(item?.goodsImg)
          .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
          .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
          .objectFit(ImageFit.Contain)
          .draggable(false) // ç¦æ­¢å›¾ç‰‡æ‹–æ‹½
          .borderRadius(8)
      }
      .width(commonConst.GOODS_IMAGE_WIDTH)
      .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // å•†å“ä¿¡æ¯åŒºåŸŸ
      Column() {
        // å•†å“åç§°
        Text(item?.goodsName)
          .fontSize(commonConst.NORMAL_FONT_SIZE)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })

        // å¹¿å‘Šè¯­
        Text(item?.advertisingLanguage)
          .fontColor($r('app.color.gray'))
          .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8, right: commonConst.MARGIN_RIGHT })

        // è¯„ä»·å’Œä»·æ ¼ä¿¡æ¯è¡Œ
        Row() {
          // è¯„ä»·ä¿¡æ¯
          Text(item?.evaluate)
            .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
            .fontColor($r('app.color.deepGray'))
            .width(commonConst.EVALUATE_WIDTH)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // ä»·æ ¼ä¿¡æ¯ï¼ˆçº¢è‰²çªå‡ºæ˜¾ç¤ºï¼‰
          Text(item?.price)
            .fontSize(commonConst.NORMAL_FONT_SIZE)
            .fontColor($r('app.color.freshRed'))
            .fontWeight(FontWeight.Bold)
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .width(commonConst.GOODS_LIST_WIDTH)
      }
      .padding(commonConst.GOODS_LIST_PADDING) // è®¾ç½®å†…è¾¹è·
      .width(commonConst.GOODS_FONT_WIDTH)
      .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .justifyContent(FlexAlign.SpaceBetween) // å­å…ƒç´ ä¸¤ç«¯å¯¹é½
    }
    .justifyContent(FlexAlign.SpaceBetween) // å•†å“å›¾ç‰‡å’Œä¿¡æ¯åŒºåŸŸä¸¤ç«¯å¯¹é½
    .height(commonConst.GOODS_LIST_HEIGHT)
    .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
  }

  // æ–°å¢ï¼šå¤„ç†æ’åºé€‰æ‹©
  private handleSortSelect(sortType: SortType, priceFilter?: PriceRangeFilter) {
    console.log('========================================');
    console.log('=== GoodsListComponent.handleSortSelect ===');
    console.log(`é€‰æ‹©çš„æ’åºç±»å‹: ${sortType}`);
    console.log(`å½“å‰æ’åºç±»å‹: ${this.currentSortType}`);
    console.log(`æ˜¯å¦ä¸ºæœç´¢æ¨¡å¼: ${this.isSearchMode}`);
    console.log(`å½“å‰åˆ†ç±»: ${this.category}`);
    
    this.currentSortType = sortType;
    
    // å¦‚æœæ˜¯ä»·æ ¼åŒºé—´ç­›é€‰ï¼Œä¿å­˜ç­›é€‰æ¡ä»¶
    if (sortType === SortType.PRICE_RANGE && priceFilter) {
      this.currentPriceFilter = priceFilter;
      console.log(`ä»·æ ¼åŒºé—´ç­›é€‰æ¡ä»¶: Â¥${priceFilter.minPrice} - Â¥${priceFilter.maxPrice}`);
    } else {
      // å…¶ä»–æ’åºæ–¹å¼æ¸…é™¤ä»·æ ¼ç­›é€‰æ¡ä»¶
      this.currentPriceFilter = null;
    }
    
    // ä¿å­˜æ’åºç±»å‹
    saveSortType(sortType);
    console.log('æ’åºç±»å‹å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
    
    if (this.isSearchMode) {
      // æœç´¢æ¨¡å¼ä¸‹ï¼Œå¯¹æœç´¢ç»“æœè¿›è¡Œæ’åº
      console.log('æœç´¢æ¨¡å¼ï¼šå¯¹æœç´¢ç»“æœè¿›è¡Œæ’åº');
      console.log(`æœç´¢ç»“æœæ•°é‡: ${this.searchResults.length}`);
      
      if (this.searchResults.length > 0) {
        console.log('å¼€å§‹æ’åºæœç´¢ç»“æœ...');
        this.sortedSearchResults = sortGoodsList(this.searchResults, sortType, priceFilter);
        console.log(`æ’åºåç»“æœæ•°é‡: ${this.sortedSearchResults.length}`);
      } else {
        console.log('æœç´¢ç»“æœä¸ºç©ºï¼Œæ— éœ€æ’åº');
        this.sortedSearchResults = [];
      }
    } else {
      // æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå¯¹æ•°æ®æºè¿›è¡Œæ’åº
      console.log('æ­£å¸¸æ¨¡å¼ï¼šå¯¹æ•°æ®æºè¿›è¡Œæ’åº');
      const dataCount = this.goodsListData.getAllData().length;
      console.log(`æ•°æ®æºå•†å“æ•°é‡: ${dataCount}`);
      
      this.goodsListData.setSortType(sortType, priceFilter);
      
      // æ›´æ–°æ‡’åŠ è½½çŠ¶æ€
      this.useLazyLoad = this.goodsListData.isLazyLoadMode();
      console.log(`æ‡’åŠ è½½çŠ¶æ€: ${this.useLazyLoad ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
      
      // éªŒè¯æ’åºåçš„æ•°æ®
      const sortedData = this.goodsListData.getAllData();
      console.log(`æ’åºåæ•°æ®æºå•†å“æ•°é‡: ${sortedData.length}`);
      
      if (dataCount !== sortedData.length) {
        console.error(`[æ’åºé”™è¯¯] æ•°æ®æºæ•°é‡å˜åŒ–: ${dataCount} -> ${sortedData.length}`);
      }
    }
    
    // æ›´æ–°åº•éƒ¨çŠ¶æ€
    this.updateBottomStatus();
    
    console.log('=== handleSortSelect å®Œæˆ ===');
    console.log('========================================\n');
  }

  // æ–°å¢ï¼šæ‰“å¼€æ’åºå¼¹çª—
  private openSortDialog() {
    this.showSortDialog = true;
  }

  // æ–°å¢ï¼šå…³é—­æ’åºå¼¹çª—
  private closeSortDialog() {
    this.showSortDialog = false;
  }

  // æ–°å¢ï¼šå¤„ç†è§¦æ‘¸äº‹ä»¶
  private handleTouch(event?: TouchEvent) {
    // æœç´¢æ¨¡å¼ä¸‹æˆ–æ‡’åŠ è½½ç¦ç”¨æ—¶ç¦ç”¨è§¦æ‘¸äº‹ä»¶å¤„ç†
    if (this.isSearchMode || !this.useLazyLoad) {
      return;
    }

    if (event === undefined) {
      return;
    }
    switch (event.type) {
      case TouchType.Down: // è§¦æ‘¸æŒ‰ä¸‹
        this.startTouchOffsetY = event.touches[0].y;
        break;
      case TouchType.Move: // è§¦æ‘¸ç§»åŠ¨
        this.endTouchOffsetY = event.touches[0].y;
        // åˆ¤æ–­æ˜¯å¦å‘ä¸Šæ»‘åŠ¨ä¸”æ¥è¿‘åº•éƒ¨ï¼Œå¦‚æœæ˜¯åˆ™åŠ è½½æ›´å¤šæ•°æ®
        if (this.startTouchOffsetY - this.endTouchOffsetY > 100 && !this.isLoading && this.useLazyLoad) {
          // å…ˆæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®å¯ä»¥åŠ è½½
          if (this.goodsListData.canLoadMore()) {
            console.log('å¯ä»¥åŠ è½½æ›´å¤šæ•°æ®ï¼Œå¼€å§‹åŠ è½½...');
            this.isLoading = true;
            this.goodsListData.pushData();
            setTimeout(() => {
              this.isLoading = false;
              // æ£€æŸ¥åŠ è½½åæ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
              this.updateBottomStatus();
              console.log('åŠ è½½å®Œæˆï¼Œæ˜¯å¦åˆ°è¾¾åº•éƒ¨:', this.hasReachedBottom);
            }, 500);
          } else {
            console.log('æ²¡æœ‰æ›´å¤šæ•°æ®å¯ä»¥åŠ è½½ï¼Œå·²åˆ°è¾¾åº•éƒ¨');
            this.updateBottomStatus();
          }
        }
        // åˆ¤æ–­æ˜¯å¦ä¸‹æ‹‰åˆ·æ–°
        if (this.endTouchOffsetY - this.startTouchOffsetY > 100 && !this.isRefreshing) {
          this.handleRefresh();
        }
        break;
    }
  }

  build() {
    // æ•´ä½“å®¹å™¨ - å‚ç›´å¸ƒå±€
    Column() {
      // æœç´¢æ¡†å’Œæ’åºæŒ‰é’®åŒºåŸŸ
      Row() {
        // æœç´¢æ¡†
        TextInput({ placeholder: 'æœç´¢å•†å“...' })
          .type(InputType.Normal)
          .width('70%')
          .height(40)
          .fontSize(14)
          .backgroundColor('#F5F5F5')
          .onChange((value: string) => {
            this.handleSearch(value);
          })
          .onSubmit(() => {
            // å›è½¦æœç´¢
            this.handleSearch(this.searchKeyword);
          })

        // æ’åºæŒ‰é’®
        Button('æ’åº')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor('#007DFF')
          .height(40)
          .width('25%')
          .margin({ left: 10 })
          .onClick(() => {
            this.openSortDialog();
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .justifyContent(FlexAlign.SpaceBetween)

      // å•†å“åˆ—è¡¨å®¹å™¨
      List({ space: commonConst.LIST_ITEM_SPACE }) {
        // åˆ·æ–°æç¤ºæ”¾åœ¨åˆ—è¡¨é¡¶éƒ¨
        if (this.isRefreshing) {
          ListItem() {
            Row() {
              // åˆ·æ–°å›¾æ ‡
              Image($r('app.media.refreshing'))
                .width(commonConst.ICON_WIDTH)
                .height(commonConst.ICON_HEIGHT)
                .alignSelf(ItemAlign.Center)
              // åˆ·æ–°çŠ¶æ€æ–‡æœ¬
              Text('æ­£åœ¨åˆ·æ–°...')
                .fontSize(commonConst.NORMAL_FONT_SIZE)
                .fontColor($r('app.color.deepGray'))
                .textAlign(TextAlign.Center)
                .width('100%')
            }
            .width('100%')
            .height(60)
            .justifyContent(FlexAlign.Center)
          }
        }

        // æ¡ä»¶æ¸²æŸ“ï¼šæ ¹æ®æœç´¢æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„å†…å®¹
        if (this.isSearchMode) {
          // æœç´¢æ¨¡å¼ä¸‹æ˜¾ç¤ºæœç´¢ç»“æœ
          if (this.sortedSearchResults.length > 0) {
            ForEach(this.sortedSearchResults, (item: GoodsListItemType) => {
              ListItem() {
                this.buildGoodsItem(item)
              }
            }, (item: GoodsListItemType) => item.id.toString())
          } else {
            // æœç´¢ç»“æœä¸ºç©ºæ—¶çš„æç¤º
            ListItem() {
              Column() {
                Text('ğŸ”')
                  .fontSize(60)
                  .margin({ bottom: 20 })
                Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“')
                  .fontSize(commonConst.NORMAL_FONT_SIZE)
                  .fontColor($r('app.color.gray'))
                  .margin({ bottom: 10 })
                Text('è¯·å°è¯•å…¶ä»–å…³é”®è¯')
                  .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
                  .fontColor($r('app.color.deepGray'))
              }
              .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
          }
        } else {
          // æ­£å¸¸æ¨¡å¼ä¸‹ä½¿ç”¨æ‡’åŠ è½½æ–¹å¼æ¸²æŸ“åˆ—è¡¨é¡¹
          LazyForEach(this.goodsListData, (item: GoodsListItemType, index: number) => {
            ListItem() {
              this.buildGoodsItem(item)
            }
          }, (item: GoodsListItemType) => item.id.toString())
        }

        // åŠ è½½æ›´å¤šæç¤ºæ”¾åœ¨åˆ—è¡¨åº•éƒ¨
        ListItem() {
          Column() {
            if (this.isLoading) {
              Text('æ­£åœ¨åŠ è½½æ›´å¤š...')
                .fontSize(commonConst.NORMAL_FONT_SIZE)
                .fontColor($r('app.color.deepGray'))
                .textAlign(TextAlign.Center)
                .width('100%')
            } else if (this.hasReachedBottom || this.sortedSearchResults.length <= 0) {
              Text($r('app.string.to_bottom'))
                .fontSize(commonConst.NORMAL_FONT_SIZE)
                .fontColor($r('app.color.deepGray'))
                .textAlign(TextAlign.Center)
                .width('100%')
            } else {
              Text('æ»‘åŠ¨åŠ è½½æ›´å¤š')
                .fontSize(commonConst.NORMAL_FONT_SIZE)
                .fontColor($r('app.color.gray'))
                .textAlign(TextAlign.Center)
                .width('100%')
            }
          }
          .width('100%')
          .height(80)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .edgeEffect(EdgeEffect.Spring) // ä½¿ç”¨å¼¹ç°§æ•ˆæœ
      .backgroundColor($r('app.color.primaryBgColor'))

      // æ’åºå¼¹çª—
      if (this.showSortDialog) {
        SortDialog({
          isVisible: this.showSortDialog,
          currentSort: this.currentSortType,
          currentPriceFilter: this.currentPriceFilter,
          onSortSelected: (sortType: SortType, priceFilter?: PriceRangeFilter) => {
            this.handleSortSelect(sortType, priceFilter);
            this.closeSortDialog();
          },
          onClose: () => {
            this.closeSortDialog();
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    // å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼ˆä»…åœ¨éæœç´¢æ¨¡å¼ä¸‹ï¼‰
    .onTouch((event?: TouchEvent) => {
      this.handleTouch(event);
    })
  }
}