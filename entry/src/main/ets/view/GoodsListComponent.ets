/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import * as commonConst from '../common/CommonConstants';
import { GoodsListItemType } from '../viewmodel/InitialData';
import { ListDataSource } from '../viewmodel/ListDataSource';

/**
 * å•†å“åˆ—è¡¨ç»„ä»¶
 * ä½¿ç”¨LazyForEachå®ç°å•†å“åˆ—è¡¨çš„æ‡’åŠ è½½æ¸²æŸ“
 * æ”¯æŒè§¦åº•åŠ è½½æ›´å¤šåŠŸèƒ½
 * æ”¯æŒæœç´¢ç»“æœæ˜¾ç¤º
 */
@Component
export default struct GoodsList {
  // æä¾›åˆ—è¡¨æ•°æ®æº
  @Provide goodsListData: ListDataSource = new ListDataSource();
  // è®°å½•è§¦æ‘¸èµ·å§‹ç‚¹Yåæ ‡
  private startTouchOffsetY: number = 0;
  // è®°å½•è§¦æ‘¸ç»“æŸç‚¹Yåæ ‡
  private endTouchOffsetY: number = 0;
  // æ˜¯å¦æ­£åœ¨åŠ è½½
  @State isLoading: boolean = false;
  // æ˜¯å¦æ­£åœ¨åˆ·æ–°
  @State isRefreshing: boolean = false;
  // åˆ†ç±»
  @Prop category: string = 'selected';
  // æœç´¢ç»“æœå•†å“åˆ—è¡¨
  @Prop searchResults: GoodsListItemType[] = [];
  // æ˜¯å¦ä¸ºæœç´¢æ¨¡å¼
  @Prop isSearchMode: boolean = false;

  aboutToAppear() {
    // å½“åˆ†ç±»æ”¹å˜æ—¶ï¼Œæ›´æ–°æ•°æ®æº
    this.goodsListData.setCategory(this.category);
  }

  // å¤„ç†ä¸‹æ‹‰åˆ·æ–°
  private handleRefresh() {
    if (this.isRefreshing) {
      return;
    }

    this.isRefreshing = true;

    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(() => {
      this.goodsListData.refreshData();
      this.isRefreshing = false;
    }, commonConst.REFRESH_DELAY);
  }

  // æ„å»ºå•ä¸ªå•†å“é¡¹
  @Builder
  buildGoodsItem(item: GoodsListItemType) {
    Row() {
      // å•†å“å›¾ç‰‡åŒºåŸŸ
      Column() {
        Image(item?.goodsImg)
          .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
          .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
          .objectFit(ImageFit.Contain)
          .draggable(false) // ç¦æ­¢å›¾ç‰‡æ‹–æ‹½
          .borderRadius(8)
      }
      .width(commonConst.GOODS_IMAGE_WIDTH)
      .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      // å•†å“ä¿¡æ¯åŒºåŸŸ
      Column() {
        // å•†å“åç§°
        Text(item?.goodsName)
          .fontSize(commonConst.NORMAL_FONT_SIZE)
          .fontWeight(FontWeight.Medium)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 4 })

        // å¹¿å‘Šè¯­
        Text(item?.advertisingLanguage)
          .fontColor($r('app.color.gray'))
          .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ bottom: 8, right: commonConst.MARGIN_RIGHT })

        // è¯„ä»·å’Œä»·æ ¼ä¿¡æ¯è¡Œ
        Row() {
          // è¯„ä»·ä¿¡æ¯
          Text(item?.evaluate)
            .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
            .fontColor($r('app.color.deepGray'))
            .width(commonConst.EVALUATE_WIDTH)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // ä»·æ ¼ä¿¡æ¯ï¼ˆçº¢è‰²çªå‡ºæ˜¾ç¤ºï¼‰
          Text(item?.price)
            .fontSize(commonConst.NORMAL_FONT_SIZE)
            .fontColor($r('app.color.freshRed'))
            .fontWeight(FontWeight.Bold)
        }
        .justifyContent(FlexAlign.SpaceBetween)
        .width(commonConst.GOODS_LIST_WIDTH)
      }
      .padding(commonConst.GOODS_LIST_PADDING) // è®¾ç½®å†…è¾¹è·
      .width(commonConst.GOODS_FONT_WIDTH)
      .height(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
      .justifyContent(FlexAlign.SpaceBetween) // å­å…ƒç´ ä¸¤ç«¯å¯¹é½
    }
    .justifyContent(FlexAlign.SpaceBetween) // å•†å“å›¾ç‰‡å’Œä¿¡æ¯åŒºåŸŸä¸¤ç«¯å¯¹é½
    .height(commonConst.GOODS_LIST_HEIGHT)
    .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
  }

  // å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼ˆä»…åœ¨éæœç´¢æ¨¡å¼ä¸‹ï¼‰
  private handleTouch(event?: TouchEvent) {
    // æœç´¢æ¨¡å¼ä¸‹ä¸å¤„ç†è§¦æ‘¸äº‹ä»¶
    if (this.isSearchMode) {
      return;
    }

    if (event === undefined) {
      return;
    }
    switch (event.type) {
      case TouchType.Down: // è§¦æ‘¸æŒ‰ä¸‹
        this.startTouchOffsetY = event.touches[0].y;
        break;
      case TouchType.Move: // è§¦æ‘¸ç§»åŠ¨
        this.endTouchOffsetY = event.touches[0].y;
        // åˆ¤æ–­æ˜¯å¦å‘ä¸Šæ»‘åŠ¨ä¸”æ¥è¿‘åº•éƒ¨ï¼Œå¦‚æœæ˜¯åˆ™åŠ è½½æ›´å¤šæ•°æ®
        if (this.startTouchOffsetY - this.endTouchOffsetY > 100 && !this.isLoading) {
          this.isLoading = true;
          this.goodsListData.pushData();
          setTimeout(() => {
            this.isLoading = false;
          }, 500);
        }
        // åˆ¤æ–­æ˜¯å¦ä¸‹æ‹‰åˆ·æ–°
        if (this.endTouchOffsetY - this.startTouchOffsetY > 100 && !this.isRefreshing) {
          this.handleRefresh();
        }
        break;
    }
  }

  build() {
    Row() {
      // å¦‚æœæ˜¯æœç´¢æ¨¡å¼ä¸”æœ‰æœç´¢ç»“æœ
      if (this.isSearchMode && this.searchResults.length > 0) {
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        List({ space: commonConst.LIST_ITEM_SPACE }) {
          ForEach(this.searchResults, (item: GoodsListItemType) => {
            ListItem() {
              this.buildGoodsItem(item)
            }
          }, (item: GoodsListItemType) => item.id.toString())
        }
        .width('100%')
        .height('100%')
        .edgeEffect(EdgeEffect.Spring) // ä½¿ç”¨å¼¹ç°§æ•ˆæœ
      } else if (this.isSearchMode && this.searchResults.length === 0) {
        // æœç´¢æ¨¡å¼ä½†æ²¡æœ‰æœç´¢ç»“æœ
        Column() {
          Text('ğŸ”')
            .fontSize(60)
            .margin({ bottom: 20 })
          Text('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“')
            .fontSize(commonConst.NORMAL_FONT_SIZE)
            .fontColor($r('app.color.gray'))
            .margin({ bottom: 10 })
          Text('è¯·å°è¯•å…¶ä»–å…³é”®è¯')
            .fontSize(commonConst.GOODS_EVALUATE_FONT_SIZE)
            .fontColor($r('app.color.deepGray'))
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // æ­£å¸¸å•†å“åˆ—è¡¨æ¨¡å¼
        List({ space: commonConst.LIST_ITEM_SPACE }) {
          // ä½¿ç”¨æ‡’åŠ è½½æ–¹å¼æ¸²æŸ“åˆ—è¡¨é¡¹
          LazyForEach(this.goodsListData, (item: GoodsListItemType) => {
            ListItem() {
              this.buildGoodsItem(item)
            }
            // ç›‘å¬è§¦æ‘¸äº‹ä»¶ï¼Œå®ç°è§¦åº•åŠ è½½æ›´å¤š
            .onTouch((event?: TouchEvent) => {
              this.handleTouch(event);
            })
          }, (item: GoodsListItemType) => item.id.toString())
        }
        .width('100%')
        .height('100%')
        .edgeEffect(EdgeEffect.Spring) // ä½¿ç”¨å¼¹ç°§æ•ˆæœ
      }

      // çŠ¶æ€æç¤ºä¿¡æ¯
      Column() {
        // åˆ·æ–°æç¤º
        if (this.isRefreshing) {
          Text('æ­£åœ¨åˆ·æ–°...')
            .fontSize(commonConst.NORMAL_FONT_SIZE)
            .fontColor($r('app.color.deepGray'))
            .textAlign(TextAlign.Center)
            .width('100%')
            .margin({ top: 20, bottom: 20 })
        }
        // åŠ è½½æ›´å¤šæç¤ºï¼ˆä»…åœ¨éæœç´¢æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
        else if (!this.isSearchMode) {
          if (this.isLoading) {
            Text('æ­£åœ¨åŠ è½½æ›´å¤š...')
              .fontSize(commonConst.NORMAL_FONT_SIZE)
              .fontColor($r('app.color.deepGray'))
              .textAlign(TextAlign.Center)
              .width('100%')
              .margin({ top: 20, bottom: 40 })
          } else {
            Text($r('app.string.to_bottom'))
              .fontSize(commonConst.NORMAL_FONT_SIZE)
              .fontColor($r('app.color.deepGray'))
              .textAlign(TextAlign.Center)
              .width('100%')
              .margin({ top: 20, bottom: 40 })
          }
        }
      }
    }
    .justifyContent(FlexAlign.Center)
    .width(commonConst.LAYOUT_WIDTH_OR_HEIGHT)
    .height('100%')
    .backgroundColor($r('app.color.primaryBgColor'))
  }
}